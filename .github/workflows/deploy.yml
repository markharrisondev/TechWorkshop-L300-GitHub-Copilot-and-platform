name: Build and Deploy to Azure App Service

on:
    push:
        branches:
            - main
    pull_request:
        branches: ["*"]
    workflow_dispatch:

env:
    AZURE_WEBAPP_NAME: ${{ vars.AZURE_WEBAPP_NAME }}
    AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP }}
    CONTAINER_REGISTRY: ${{ vars.AZURE_CONTAINER_REGISTRY }}
    IMAGE_NAME: zavastorefrontweb

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Log in to Azure
              uses: azure/login@v2
              with:
                  creds: ${{ secrets.AZURE_CREDENTIALS }}

            - name: Log in to Azure Container Registry
              run: |
                  az acr login --name ${{ env.CONTAINER_REGISTRY }}

            - name: Build and push Docker image
              run: |
                  docker build -t ${{ env.CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} \
                               -t ${{ env.CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:latest \
                               ./src
                  docker push ${{ env.CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
                  docker push ${{ env.CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:latest

            - name: Deploy to Azure App Service
              uses: azure/webapps-deploy@v3
              with:
                  app-name: ${{ env.AZURE_WEBAPP_NAME }}
                  resource-group-name: ${{ env.AZURE_RESOURCE_GROUP }}
                  images: ${{ env.CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}

            - name: Logout from Azure
              if: always()
              run: |
                  az logout
