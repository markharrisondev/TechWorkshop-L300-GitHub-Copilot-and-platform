name: Build and Deploy to Azure Container App

on:
    push:
        branches:
            - main
    pull_request:
        branches: ["*"]
    workflow_dispatch:

env:
    AZURE_CONTAINER_APP_NAME: ${{ vars.AZURE_CONTAINER_APP_NAME }}
    AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP }}
    CONTAINER_REGISTRY: ${{ vars.AZURE_CONTAINER_REGISTRY }}
    IMAGE_NAME: zavastorefrontweb

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Log in to Azure
              uses: azure/login@v2
              with:
                  creds: ${{ secrets.AZURE_CREDENTIALS }}

            - name: Log in to Azure Container Registry
              run: |
                  az acr login --name ${{ env.CONTAINER_REGISTRY }}

            - name: Build and push Docker image
              run: |
                  docker build -t ${{ env.CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} \
                               -t ${{ env.CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:latest \
                               ./src
                  docker push ${{ env.CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
                  docker push ${{ env.CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:latest

            - name: Deploy to Azure Container App
              run: |
                  az containerapp update \
                    --name ${{ env.AZURE_CONTAINER_APP_NAME }} \
                    --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
                    --image ${{ env.CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}

            - name: Logout from Azure
              if: always()
              run: |
                  az logout
